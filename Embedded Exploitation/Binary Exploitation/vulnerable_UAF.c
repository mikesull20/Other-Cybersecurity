#include <stdio.h>
#include <stdlib.h>

void vulnerable_function() {
    char *buffer = (char *)malloc(100);  // Allocate memory
    if (buffer == NULL) {
        fprintf(stderr, "Memory allocation failed\n");
        exit(1);
    }

    snprintf(buffer, 100, "This is a test buffer");  // Use allocated memory

    free(buffer);  // Free the memory

    // Use-After-Free: Attempting to access the freed memory
    printf("%s\n", buffer);  // Undefined behavior

    // Allocating new memory (might be at the same address)
    char *new_buffer = (char *)malloc(100);
    if (new_buffer == NULL) {
        fprintf(stderr, "Memory allocation failed\n");
        exit(1);
    }
    
    // This might now overwrite the previous freed memory.
    snprintf(new_buffer, 100, "New data in reused memory");

    // Accessing the old buffer again
    printf("%s\n", buffer);  // Still undefined behavior, but now might show "New data in reused memory"

    free(new_buffer);  // Free the new memory
}

int main() {
    vulnerable_function();
    return 0;
}